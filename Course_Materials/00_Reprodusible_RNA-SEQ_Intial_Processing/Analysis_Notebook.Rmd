---
title: " RNA-seq analysis "
output: html_notebook
---


# 1. Basic Unix


UNIX is an operatig system that was developed in the 1960 and it have been the base of widelly used operative sistems such as Linux and Mac OS. As the data coming out from biological outputs growing exponentially through time, Knowing the unix basics have become essential to do bioinformatics. Here there is a list of the most used commands:


|Commad| Use| Examples|  
|--:|--:|-----:|
|`cd` | Tove between directories| `cd FASTQ` (to enter a folder)|
|`cd ..` | To change to the parent of the current directory| |
|`cd -` | To go to previous directory| |
|`pwd` | Where am I?| |
|`ls` | List files | `ls` (on this directory); `ls FASTQ` (list files inside FASTQ) |
|`mkdir` | make new directory| `mkdir my_folder` |
|`mv` | move a file or directory| `mv file my_folder/` (move file to a folder) |
|`cp` | copy file| `cp my_folder/* new_folder/` (copy all files of al folder) |
|`rm` |Remove a file or folder| `rm file`; `rm -rf folder` |
|`less` |Displays the contents of a file| `less file.txt` (press `q` to quit) |
|`head`| Displays the first ten lines of a file | |
|`tail`| Displays the last ten lines of a file | |
|`cat` |Print file content|`cat file1 file2 > file.total` (merge files)|
|`zcat` |Print file content of compresed files|`zcat SRR7889597.fastq.gz` |
|`gzcat` |mac OSx version of zcat   |`gzcat SRR7889597.fastq.gz` |
|`wc` | word count | `wc -l file ` (count lines inside of a file)|
|`grep` | Pattern matching | `grep patern file` (get lines that match the patern)|
| `cut` | extract columns from files | `cut -f 2 file` (extract second column)
|`sort` | sort file by column |`sort -nr -k 2 file` (sort file by second column) | 


**Exercise 1.0.1**

On the course directory, create a folder named `test_folder` and copy the smallest file inside `FASTQ/` folder. Then change the name of the folder that you just create to `to_delete` and finally remove this folder. 


## 1.2 Efficient use of the termial 


To accelerate our interaction with the terminal, we can use the TAB key:  

![](Images/TAB.png) 

For instance, if you are at course folder and you write `ls Gene_` and then press TAB key once, it will complete the command to `ls Gene_annotation`. But if you just write `ls G` and press TAB two times, it will show you the two options (Gene_annotation and Genome).

An other powerful thing is to pipe (`|`) the output of one comand into and other command. For exmaple you can do:

`ls FASTQ/*.fastq.gz | wc -l`

To count all the FASTQ files that are stored at inside of `FASTQ/` folder.

Finally, if you want to now more, every command has its own options, you can see the entire description of a command using `man`. For instance, use man to know more about `head` typing on the command line:

`man head`

**Exercise 1.2.1**

Read the manual of `head` command. Then use it to extract the first 100 lines of `Gene_annotation/dm6.Ensembl.genes.gtf` and count all the lines that has `CDS` at the thrid column. 


# 2. Input data format


In order to quantify mRNA by RNA-seq analysis, different files are required which as a different format. RNA-Seq reads are normally formatted as [FASTQ](https://en.wikipedia.org/wiki/FASTQ_format), SRA or CRAM. To process this data, the most common initial step is to map the reads to the genome, which is often formatted as [FASTA](https://en.wikipedia.org/wiki/FASTA_format). Finally, to quantify gene expression, we need to know which part of the genome encodes for genes. This information can be found at gene annotation files, which can be formatted as [GTF](http://mblab.wustl.edu/GTF22.html#fields) or [BED](https://genome.ucsc.edu/FAQ/FAQformat.html#format1) files. Explore the different hiperlinks provided for detailed information about the different file formats.


## 2.1 FASTA format

FASTA files contain nucleotide or amino acid sequence information. The data is composed of identifiers, which starts with `>` and nucleotide o amino acid sequences. Hundred of thousands of genomes coming from different species are available in public repositories as FASTA files. It is important to notice that a given species can have different genomic assemblies. For instance, a popular assembly human genome assembly is `hg19` that was published in February 2009, and as a huge amount of data is available for that assembly some researchers keep doing their analyses with that version. But other recent analyses have started to use `hg38` instead, which was published in December 2013 and represent a more curated version of the human genome.

For today's practice, we are going to work with a smaller genome. We already have downloaded for you the `dm6` assembly of D. melanogaster's genome, an invertebrate organism widely used as a model organism for genetic and behavioral studies. The genome file is at course material folder at `Genome/dm6.fa`. 

**Exercise 2.1.1**

Count the number of sequences present at `dm6.fa` (hint: count lines that start with `>`, but as this is a special UNIX character, refer to it as `\>'. Which command can be used for pattern matching and count lines?). 

If each sequence is related to a chromosome, why do we find so many sequences? How many main scaffolds can you see?

**Exercise 2.1.2**

Can you calculate the exact number of nucleotides that this D. melanogaster assembly is made of? (hint: explore additional options of grep and wc)


## 2.2 FASTQ format

RNA-seq reads often come as FASTQ, which is an extension of FASTA file format. Every read is represented by four lines:

* First line: start with `@` and correspond to a read identifier. 
* Second line: read nucleotide sequence.
* Third line: Start with `+` and it can be followed by additional information, but often it is just `+`.
* Fourth line:  Phred quality score represent the reliability of a base call (as higher the better). It is encoded as ASCII characters. It can have different encodings, such as Sanger, Solexa, Illumina 1.3+ or Illumina 1.8+. Please check [FASTQ format description](https://en.wikipedia.org/wiki/FASTQ_format) for more details.

**Exercise 2.2.1**

Which of the fastq files found at `FASTQ/` has the highest and the lowest amout of reads? How many reads do they have? What is the read lenght?


## 2.3 Gene annotation

Efforts have been made to identify the genomic regions that encode for genes. This information can be stored as BED or GTF files (among other formats). BED files store information about genomic coordinates. Each row of a BED file represents a genomic interval, in the case of gene annotation file, it represents the start and end of a transcript. Exons coordinates are encoded as `blocks`, where the `blockStarts` column is a list of all exon starts relative to the transcript starts and `blockSizes` column contain all the exon sizes. Plase read [BED description format](https://genome.ucsc.edu/FAQ/FAQformat.html#format1) for more information. 

GTF files instead are gene-centric annotations, in which a gene can be described by multiple rows. Each row contains the coordinates and additional information of a particular gene feature. Please check the full [GTF description](http://mblab.wustl.edu/GTF22.html)


**Exercise 2.3.1**


Get D. melanogaster gene annotation files for `dm6` assembly in from [UCSC Table Browser](http://genome-euro.ucsc.edu/cgi-bin/hgTables). Choosing the following values:

* clade: Insect.
* genome: D. melanogaster.
* assembly: Aug. 2014 (BDGP Release 6 + ISO1 MT/dm6).
* group: Gene and Gene Predictions.
* track: Ensembl Genes.
* table: ensGene.

And get the annotation files as BED and GTF (choosing the right output formats). Save the BED file as `dm6.Ensembl.genes.bed12` and GTF as `dm6.Ensembl.genes.gtf` at `Gene_annotation` folder.


**Exercise 2.3.2**

Process `dm6.Ensembl.genes.bed12` to find the five transcripts with the highest number of exons. 

**Exercise 2.3.3**

Process `dm6.Ensembl.genes.bed12` to find the total number of genes


# 3. Quality control before alingment


## 3.1 FASTQC


To perform a QC of the Fastq files we can use *FastQC*. We can access to a basic manual of this tool by typing on `fastqc --help` on terminal.


Let's create a directory to do a GC analysis of the data


**Exercise 3.1.1**

Create a directory named `QC`. Run `fastqc` for `FASTQ/SRR7889584.fastq.gz` store the resutls at the newly created folder. You will get an html file as output; Open it with a internet browser (Chrome, firefox, etc) and answere the following quesions 

A) What is the read leght?
B) Does the quality score very throught the read lenght?
C) How is the data quality?



## 3.2 Metadata analysis on R-studio


The fastq.gz files that we have at `/FASTQ` correspond to RNA-seq data extracted from D. melanogaster brain samples. The data corresponding to a full study published last year on [Cell Reports](https://www.ncbi.nlm.nih.gov//pubmed/30355484) and the full study was published in [SRA archive](https://trace.ncbi.nlm.nih.gov/Traces/sra/?study=SRP162335). 

**Exercise 3.2.1**

Check the [study runs](https://trace.ncbi.nlm.nih.gov/Traces/study/?acc=SRP162335) and compare with the file names from `FASTQ/` folder. Which tissues the samples were extracted from? Select the Runs that correspond to the files that we have and download the `RunInfo Table` corresponding to these tables and save it as `SraRunTable.txt` on the course folder. 

**Exercise 3.2.2**

Open R-studio and open the `Analysis_Notebook.Rmd` file that is located at the course folder. This is an R-notebook file, that has all the code used to generate this document. But, now when you open this file you will be able to run `chunks` of code interactively inside R-studio. Run the following chunk by clicking at the green play button.
 

```{r}

library(data.table)

metadata <- fread("SraRunTable.txt")

metadata
```


By running this code, we imported the metadata as a data.table object, which correspond to a very convenient structure to manipulate data in R. For more information visit this [link](https://www.datacamp.com/community/tutorials/data-table-cheat-sheet). We can now easily manipulate the data! For example, we can filter the metadata rows, so we only see the ones corresponding to "central neurons"



```{r}
metadata[source_name=="central neurons" , ]
```


We can also get explore if we have a lowly sequenced sample filtering by the `MBases` values

```{r}
metadata[MBases < 100 , ]
```


Or get the average Mega bases across this sample

```{r}

metadata[  , mean(MBases) ]

```


To explore this visualy, we can plot with ggplot2. This is one of the most popular packages to visualize data. A basic code to visualize the Mbases distribution can be run as:

```{r}
library(ggplot2)

ggplot(data = metadata) +  # Frist layer - Data input
  geom_bar(aes(x=Run, y=MBases), stat = "identity")   # second layer - type of plot and axis

```


We can rotate the text to make it more visible

```{r}

ggplot(data=metadata) +
  geom_bar(aes(x=Run, y=MBases, ), stat = "identity") + 
  theme(axis.text.x = element_text(angle = 45))  # Third layer -  visual configuration

```




inside `aes( )` are the variables and we can also define a variable as the colour:


```{r}
ggplot(data=metadata) +
  geom_bar(aes(x=Run, y=MBases, colour=source_name), stat = "identity") + 
  theme(axis.text.x = element_text(angle = 45))
```

But for this particular type of graph, filling the bar with one colour is more suitable

```{r}
ggplot(data=metadata) +
  geom_bar(aes(x=Run, y=MBases, fill=source_name), stat = "identity") + 
  theme(axis.text.x = element_text(angle = 45))
```



From this plot, we can clearly see that one of the samples that were taken from central neurons is much smaller than the rest. This factor needs to be considered at the time we analyze the samples, as this poorly sequenced sample might have lead to less accurate mRNA quantification and it might need to be removed for quantitative analyses. 



# 4. Mapping reads to the genome




After we have a diagnosis of the data quality, we can start to analyse the data. Usually the first step into the analysis requires mapping the RNA-seq reads to the genome. There are nomerous tools to do perform short read aligment and the choice of it shoud be carefolly made accordint ot the analysis goals and requirements. Hisat2 is a very fastq tool that have been shown to have a good performace on published benchmars. 

To start mapping RNA-seq reads to the genome, we need to index the genome. The command to do this is `hisat2-build`. 


## 4.1 Indexing the genome for Hisat2


```{bash}
hisat2-build --help
```


On the comand-line execute (you need to be at the Course_materials folder)

```{bash}

hisat2-build -p 5 Genome/dm6.fa Genome/Index/dm6

```


This command will use the genome (located at `Genome/dm6.fa`) and it will generate the index files on `Genome/Index/`. All the files will start with `dm6` prefix


## 4.2 Runing hisat2


To map the reads to the genome we need to run hisat2. Take a quick look to hisat2's description

```{bash}
hisat2 --help

```

**Exercise 4.2.1**

Run hista2 for the smallest file, SRR7889582.fastq, located at FASTQ folder using 5 proccesors. Save the results inside a folder named `hisat2` (create it with mkdir), under the file name of hisat2/SRR7889582.sam
hint: Use -p -U -x -S flags


# 5. Quality control after alingment


# 6. Gene quantification


## 7.1 Bigwig files

## 7.2 Bigwig files

# 8. Workflow mannager



----------------------------Day two-------------------------------------------





# Genomebrowser visualization


# Transcriptome Assembly


# 9. Aligment-free quantification (Salmon)

```{r}
#<img src="Images/TAB.png" width="100" style="float": "right"> 
```












-----------------------OLD FILE------------------------------------







```{r}
library(data.table)
library(readr)
library(ggplot2)
library(RUVSeq)
library(RColorBrewer)

```


# Indroduction



The objetive of this session is to learn the essential bioinformatics concepts of RNA-seq analysis. We are goint to use high-performace data analysis tools to process data comming from fruit fly brains. The data have been recently published on [SRA](https://trace.ncbi.nlm.nih.gov/Traces/sra/?study=SRP162335) and aparently the paper have not been out yet, therefore any conclusion we do with this data can be a new discovery. EXCITING! Due to time restrictions, we only are going to work with samples corresponding to glia and neurons. These are the two principal brain componets. The questions that we are going to try to answere during this practical are:
  1.- Is the data good quality ?
  2.- Can we detect gene expression profile difrences beteween glia and neurons?
  3.- Can we detect alternative splicing paters specific to neurons or glial cells?


# Experiment desing and basic R commands


First we are going to inspect the study Medadata. In order to load it in to this R session, you can use the following command



```{r}

metadata <- data.table(read_delim("SraRunTable.txt", "\t", escape_double = FALSE, trim_ws = TRUE))

```


We imported the metadata as a data.table object, which correspond to a very convenient structure to manipulate data in R. For more information visit this [link](https://www.datacamp.com/community/tutorials/data-table-cheat-sheet). For example, we can filter the metadata rows, so we only see the ones corresponding to "central neurons"



```{r}
metadata[source_name=="central neurons" , ]
```


We can also get explore if we have a lowly sequenced sample filtering by the `MBases` values

```{r}
metadata[MBases < 100 , ]
```


Or get the average Mega bases across this sample

```{r}

metadata[  , mean(MBases) ]

```


To explore this visualy, we can plot with ggplot2. This is one of the most popular packages to visualize data. A basic code to visualize the Mbases distribution can be run as:

```{r}
ggplot(data = metadata) +  # Frist layer - Data input
  geom_bar(aes(x=Run, y=MBases), stat = "identity")   # second layer - type of plot and axis

```


We can rotate the text to make it more visible

```{r}

ggplot(data=metadata) +
  geom_bar(aes(x=Run, y=MBases, ), stat = "identity") + 
  theme(axis.text.x = element_text(angle = 45))  # Third layer -  visual configuration

```


In this case, we are using the `geom_bar` function. Do `?geom_bar` to have ore information about this function


```{r}
?geom_bar
```


inside `aes( )` are the variables and we can also define a variable as the colour:


```{r}
ggplot(data=metadata) +
  geom_bar(aes(x=Run, y=MBases, colour=source_name), stat = "identity") + 
  theme(axis.text.x = element_text(angle = 45))
```

But for this particular type of graph, filling the bar with one colour is more suitable

```{r}
ggplot(data=metadata) +
  geom_bar(aes(x=Run, y=MBases, fill=source_name), stat = "identity") + 
  theme(axis.text.x = element_text(angle = 45))
```


### Beginer's challenge

Do the same type of plot than above, but use `MBytes` instead. 




# Quality Control (QC)


To perform a QC of the Fastq files we can use *FastQC*. We can access to a basic manual of this tool by typing on `fastqc --help` on terminal, or by runing the next *bash* chunck


```{bash}

fastqc --help

```


Let's create a directory to do a GC analysis of the data


```{bash}

mkdir QC

```


### Challenge

Run fastqc for `FASTQ/SRR7889584.fastq.gz` and store the resutls at the newly created folder.
Open the obtained html output with a internet browser (Chrome, firefox, etc)

### Questions

What is the read leght?
Does the quality score very throught the read lenght?
How is the data quality?




# Mapping read to the genome



After we have a diagnosis of the data quality, we can start to analyse the data. Usually the first step into the analysis requires mapping the RNA-seq reads to the genome. There are nomerous tools to do perform short read aligment and the choice of it shoud be carefolly made accordint ot the analysis goals and requirements. Hisat2 is a very fastq tool that have been shown to have a good performace on published benchmars. 

To start mapping RNA-seq reads to the genome, we need to index the genome. The command to do this is `hisat2-build`. 


## Genome indexing 


```{bash}
hisat2-build --help
```


On the comand-line execute (you need to be at the Course_materials folder)

```{bash}

hisat2-build -p 5 Genome/dm6.fa Genome/Index/dm6

```


This command will use the genome (located at `Genome/dm6.fa`) and it will generate the index files on `Genome/Index/`. All the files will start with `dm6` prefix


## Mapping reads to the genome


To map the reads to the genome we need to run hisat2. Take a quick look to hisat2's description

```{bash}
hisat2 --help

```

### Challegne

Run hista2 for the smallest file, SRR7889582.fastq, located at FASTQ folder using 5 proccesors. Save the results inside a folder named `hisat2` (create it with mkdir), under the file name of hisat2/SRR7889582.sam
hint: Use -p -U -x -S flags


# Lets RUN them all!!!!

We have a master script called 'snakemake'. Go to the course_material directory on the comand-line and run:


```{bash}

#Reduce the number of cores if your machine does not have this many available 

snakemake featureCounts/TOTAL.gene_count.txt --cores 7

```


This script will paralelize all the processes for the other files and it will generate a gene count file (`featureCounts/TOTAL.gene_count.txt`) which is the output of featureCounts. We will explain this on more detail.

# Diferential expression analysis


There are serveral methods to perform differential gene expression analysis. Today we are going to use Deseq2, one of the most widely used methods for assessing changes on gene expression. The first step is to import the output of *featureCounts* as *data.table* object. 


### Challenge


Use the *Import Dataset* button at the top-right corner and select *from CSV*. Use de *Browse* button to get to the file path. Look for the `TOTAL.gene_count.txt` file inside `featureCounts` folder. Use `#` as Quotes and select the appropriated delimiter. Make sure than the preview looks like a table and then clic import. 



```{r}

### Solution ###


TOTAL_gene_count <- read_delim("featureCounts/TOTAL.gene_count.txt", 
    "\t", escape_double = FALSE, comment = "#", 
    trim_ws = TRUE)



```


Now we have the featureCount's output as an object in R, we can visualize it on the cell bellow.


```{r}
TOTAL_gene_count
```

###Questions

Why do we have repeated values for `Chr` and `Start`?
How many genes do we have in the analysis? hint: use `dim()` or `nrow()`


## Data exploration

To continue with the analysis we first need to adapt the format of our *gene count matrix*. The following code will generate an data.table object called `cts`. This format will allow us to run Deseq2, one of the most widely used programs to perform differential gene expression analyses. For more information read Deseq2 [manual](https://bioconductor.org/packages/release/bioc/vignettes/DESeq2/inst/doc/DESeq2.html). Part of the downstream code were based on "Count matrix input" and "Differential expression analysis" sections.

```{r}

TOTAL_gene_count <- data.frame(TOTAL_gene_count) 

cts <- TOTAL_gene_count[ ,7:ncol(TOTAL_gene_count)]
colnames(cts) <- substring(names(cts), 8,17)
rownames(cts) <- TOTAL_gene_count$Geneid

coldata <- data.frame( condition = metadata$source_name, row.names = metadata$Run )

cts <- cts[, rownames(coldata)]
```

###Question

What are the differences between `TOTAL_gene_count` and `cts`?
What kind of information does `coldata` contain? Why do we need that to perform differential gene expression analysis?



## Principal component analysis


We are going to use principal compoent analysis (PCA) to have an overview of the sample differeces. If you are not familiar with PCA and you have headphones, you can watch this [video]("https://www.youtube.com/watch?v=HMOI_lkzW08"). For making the PCA, we are going to use a function of the `RUVSeq` package ; `plotPCA`,  which requires us to store our data on a `newSeqExpressionSet` object. Do not worry if you don't understand the code, let just focus on the output plot for now ! 


```{r}



colors <- brewer.pal(3, "Set2")
set <- newSeqExpressionSet(as.matrix(cts),
                             phenoData = coldata )
plotPCA(set, col=colors[coldata$condition], cex=1.2)  

```


### Questions

What is the main conclusion of our PCA? 
Do we have consistent differences on gene expression profiles in between glia and neurons?
What does PC1 represents?
Which cell type has more transcriptional variability?


## Running Deseq2 


To run `Deseq2` we nee to store our gene expresion data on a `DESeqDataSetFromMatrix` object. 

```{r}
library(DESeq2)

dds <- DESeqDataSetFromMatrix(countData = cts,
                              colData = coldata,
                              design = ~ condition)

```


We are now ready to run Deseq2!

```{r}
dds <- DESeq(dds)
```

The `dds` object store many different type of output infromation. To extract the main result table, we need to use `results()` fucntion. Then we can convert the output table into a data.table object, which is convenient to futher data exploration.

```{r}
res <- results(dds)
restable <- data.frame(res)
restable$GeneID <- rownames(restable)
restable <- data.table(restable)
restable
```

### Question

Why do we have missing values?

## Signigicant genes

Using the function `order()` we can sort genes by their corrected pvalue (`padj`)

```{r}
restable[order(padj)]

```

The genes with smaller `padj` trend to have biger differences (`log2FoldChange`). We can define as significant the genes that `padj>0.05`. We can define a new column (`sig`) to classify by this criterium. 


```{r}
restable <- restable[!is.na(padj), ]   # Removing missing p-values (when there are not enough counts, padj cannot be estimated)

restable[ padj<0.05 , sig:=TRUE ]
restable[ padj>0.05 , sig:=FALSE ]
```


In order to see the results, we can do a *vulcano plot*, which correspond to log2FoldChange vs -log(padj). To see if our significant criterium is acceptable, we are going to colour significant genes on red. 

```{r}



ggplot(data=restable) +
  geom_point(aes(x=log2FoldChange, y=-log(padj), colour=sig ))
```

Ooops! By default, ggplot2 plot FALSE as red.   
TIP: To actually plot the significant genes in red, we need to swap the factors



```{r}


restable$sig <- factor(restable$sig , levels = c(TRUE, FALSE) ) # swapping factors

ggplot(data=restable) +
  geom_point(aes(x=log2FoldChange, y=-log(padj), colour=sig ))
```


```{r}
restable
```


But, eventhough some genes has a significant padj, only genes with a big absulute log2FoldChange will be biologically meaningful. Thus, we should redifine our significanse condition to be limmited only to genes which has an absolute log2FoldChange value greater than 1. 

### Challenge 

A) Re-define `sig` column to match our new criterium. How many significant genes do we have under this criterium? generate the vulcano plot
Hint: use `padj<0.05 & abs(log2FoldChange)>=1` as new condition and generate. 

B) Generate an MA plot ( x=log2(baseMean) ; y=log2FoldChange).Does the signidicant genes distribute uniformely across x-axis? 


```{r}

### Solution  ##

ggplot(data=restable) +
  geom_point(aes(x=log2(baseMean), y=log2FoldChange, colour=sig ))

```


###  Bonus Challenge! 

(leave this for the end)
Re-do the analysis but exclude the sample with fewer reads. Low depth samples might interfere with the analysis. 










Sys.setenv(PATH='/Users/gp7/miniconda2/bin:/usr/bin:/bin:/usr/sbin:/sbin:/usr/local/bin:/Library/TeX/texbin:/usr/local/munki:/opt/X11/bin:/usr/local/git/bin')